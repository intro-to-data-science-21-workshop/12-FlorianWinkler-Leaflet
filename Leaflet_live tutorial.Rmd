---
title: "Leaflet: Creating Interactive Maps in R"
author: "Florian Winkler and Jiayu Yang"
date: "November 4, 2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

Who doesn't love maps?

[Leaflet](http://rstudio.github.io/leaflet/) is one of the most popular open-source [JavaScript](https://leafletjs.com/) libraries for creating interactive maps. It's used by websites ranging from the New York Times and Washington Post to GitHub and Flickr, as well as [GIS](https://en.wikipedia.org/wiki/Geographic_information_system) specialists like OpenStreetMap and Mapbox. As aspiring data scientists, leaflet can help you visualize and communicate findings from your research and projects through interactive maps.

Leaflet is open-source, free, easy to learn, well-documented, has a large community, and can be extended with lots of plugins. The best thing about it? You don't need to know JavaScript. The Leaflet package in R makes it very easy to create and integrate Leaflet maps in R.

## Motivation

Are you ready to create this interactive map of COVID cases across Europe in just under 20 minutes? ðŸ˜Ž

![](motivation.png "covid cases europe")

Yes, you're right. This is not interactive. Well, this is just a screenshot (for now). Let's get started!

## Installation

To install the Leaflet package in R, run this command at your R prompt:

```{r eval=FALSE}
install.packages("leaflet")
```

Once installed, you can use the Leaflet package at your R console, in R Markdown documents, and in Shiny applications ([Shiny](https://shiny.rstudio.com/) is an R package used for creating interactive web apps such as dashboards).

## Loading Packages

Next, we're loading all the packages that we are going to use throughout this tutorial.

```{r, message = FALSE}
library(leaflet)
library(tidyverse)
library(scales)
library(lubridate)
```

# Basic Syntax: Your First Map

You create a Leaflet map with these basic steps:

1.  Create a map widget by calling `leaflet()`.

2.  Add *layers* (i.e., features) to the map by using layer functions (e.g.Â `addTiles`, `addMarkers`, `addPolygons`) to modify the map widget.

3.  Repeat step 2 as desired.

4.  Print the map widget to display it.

Here's a basic example. Guess where we are? Try clicking on the marker to confirm.

```{r}
first_map <- leaflet() %>% # leaflet works with the pipe operator
  addTiles() %>% # sets up the default OpenStreetMap map tiles
  addMarkers(lng = 13.3893204, lat = 52.5128055, popup = 'Hertie School')

first_map
```

# Basemaps

## Default (OpenStreetMap) Tiles

Leaflet supports basemaps (i.e., the underlying map you're working with) using [map tiles](https://www.mapbox.com/guides/how-web-maps-work/) (this is also how Google Maps works in principle). The easiest way to add map tiles is by calling `addTiles()` with no arguments; by default, [OpenStreetMap](https://www.openstreetmap.org/) tiles are used.

## Third-Party Tiles

Alternatively, you can also use other basemaps for your projects. Many popular free third-party basemaps can be added using the `addProviderTiles()` function (see here for a collection of [basemaps](http://leaflet-extras.github.io/leaflet-providers/preview/index.html) to choose from). Let's try out "CartoDB.Voyager".

```{r}
second_map <- leaflet() %>%
  addProviderTiles(providers$CartoDB.Voyager) %>% # third-party map tiles from CartoDB.Voyager
  addMarkers(lng = 13.3893204, lat = 52.5128055, popup = 'Hertie School')

second_map
```

The range of basemaps to choose from is long. Fancy a watercolor map for your next project?

```{r}
third_map <- leaflet() %>% # leaflet works with the pipe operator
  addProviderTiles(providers$Stamen.Watercolor) %>% # third-party map tiles from Stamen.Watercolor
  addMarkers(lng = 13.3893204, lat = 52.5128055, popup = 'Hertie School')

third_map
```

For now, we'll stick with the "CartoDB.Voyager" basemap (from our second map).

# Our Data: COVID-19 in Europe

To show you a real-world example of how we can create and use Leaflet maps, we're going to visualize COVID data from European countries. We've compiled a small data set from the [COVID-19 Data Repository](https://github.com/CSSEGISandData/COVID-19) hosted by the Johns Hopkins University (JHU) that can be downloaded from our workshop repository (credits to Riddhiman on the [R'tichoke blog](https://rtichoke.netlify.app/post/covid_visualisation_using_leaflet/) for providing a summarized version of the JHU data set).

```{r}
europe <- read.csv('leaflet_covid_data.csv')
glimpse(europe)
```

Note that we need **spatial data** to create maps that are meaningful and informative. In our example, we use **latitude and longitude** data for specific locations (note the latitude and longitude variables in the data set). However, spatial data can also exist in a variety of other formats and can contain more than just location-specific information. For a list of data formats that leaflet can work with, see [here](http://rstudio.github.io/leaflet/map_widget.html#the-data-object).

# Markers

We can use markers to call out points on a map. Marker locations are expressed in latitude/longitude coordinates, and can either appear as icons or as circles. Icon markers are added using the `addMarkers` function. Their default appearance is a dropped pin.

```{r}
markers <- europe %>% 
  filter(mon_yr == "2021-09") %>% 
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addMarkers(lng = ~Longitude, 
             lat = ~Latitude)

markers
```

# Labels

The `label` option can be used to display a text label. A label is a textual or HTML content that can be attached to markers and shapes to be always displayed or displayed on mouse over. Unlike popups (one step below), you don't need to click a marker for the label to be shown.

```{r}
labels <- europe %>% 
  filter(mon_yr == "2021-09") %>% 
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addMarkers(lng = ~Longitude, 
             lat = ~Latitude,
             label = ~country)

labels
```

# Popups

The `popup` argument can be used to add a message to be displayed on click. Popups are small boxes containing HTML that point to a specific point on the map. We want popups to show some COVID data per country, such as confirmed cases, deaths and fatality rates.

```{r}
popups <- europe %>% 
  filter(mon_yr == "2021-09") %>% 
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addMarkers(lng = ~Longitude, 
             lat = ~Latitude, 
             popup = ~paste0("<b>", country, "</b><br>", 
                             "Confirmed Cases: <b>", confirmed, "</b><br>", 
                             "Deaths: <b>", deaths, "</b><br>", 
                             "Fatality Ratio: <b>", fatal_rate, "</b><br>"))

popups
```

If you click on a marker, you will see that we have successfully created popups for each country marker. However, the COVID numbers are not presented in the most interpretable format as they are shown as raw numeric values (i.e., no thousands separator, no percentage values for fataility ratio). In the next step, we will refine our popup text by transforming our data using the scales package.

```{r}
europe <- europe %>% 
  mutate(confirmed_readable = scales::label_number_si(accuracy = 0.1)(confirmed), 
       deaths_readable = scales::label_number_si(accuracy = 0.1)(deaths), 
       fatal_readable = scales::percent(fatal_rate, accuracy = 0.1))

popups_clean <- europe %>% 
  filter(mon_yr == "2021-09") %>% 
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>%
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addMarkers(lng = ~Longitude, 
             lat = ~Latitude, 
             popup = ~paste0("<b>", country, "</b><br>", 
                             "Confirmed Cases: <b>", confirmed_readable, "</b><br>", 
                             "Deaths: <b>", deaths_readable, "</b><br>", 
                             "Fatality Ratio: <b>", fatal_readable, "</b><br>"))

popups_clean
```

# Circle Markers

Let's say we wanted to visualize how confirmed COVID cases were distributed across European countries in September 2021 on a map. We can do so by adding circle markers that change in the size of their radius per confirmed cases. Again, credits to Riddhiman on the [R'tichoke blog](https://rtichoke.netlify.app/post/covid_visualisation_using_leaflet/) for the inspiration (we're only focusing on Europe here though).

## Confirmed Cases Across Countries

### Step 1: Add Circle Markers

```{r}
cases_circles <- europe %>% 
  
  # Select only confirmed cases as of September 2021
  filter(mon_yr == "2021-09") %>% 
  
  # Call Leaflet function and add map tiles
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>% 
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  
  # Add circle markers (same radius for now)
  addCircleMarkers(lng = ~Longitude, 
                   lat = ~Latitude,
                   popup = ~paste0("<b>", country, "</b><br>", 
                             "Confirmed Cases: <b>", confirmed_readable, "</b><br>", 
                             "Deaths: <b>", deaths_readable, "</b><br>", 
                             "Fatality Ratio: <b>", fatal_readable, "</b><br>"))

cases_circles
```

### Step 2: Change circle radius according to COVID cases

```{r}
cases_circles <- europe %>% 
  
  # Select only confirmed cases as of September 2021
  filter(mon_yr == "2021-09") %>% 
  
  # Create new variable for circle radius (arbitrary scaling function for dramatic effect)
  mutate(rad = sqrt(confirmed/max(confirmed)) * 50) %>% 
  
  # Call Leaflet function and add map tiles
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>% 
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  
  # Add circle markers that change size according to confirmed cases
  addCircleMarkers(lng = ~Longitude, 
                   lat = ~Latitude, 
                   popup = ~paste0("<b>", country, "</b><br>", 
                             "Confirmed Cases: <b>", confirmed_readable, "</b><br>", 
                             "Deaths: <b>", deaths_readable, "</b><br>", 
                             "Fatality Ratio: <b>", fatal_readable, "</b><br>"),
                   
                   radius = ~rad) # Adjust circle radius to "rad" value

cases_circles
```

### Step 3: Refine appearance of circles (color and transparency)

```{r}
cases_circles <- europe %>% 
  filter(mon_yr == "2021-09") %>% 
  mutate(rad = sqrt(confirmed/max(confirmed)) * 50) %>%
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 5)) %>% 
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addCircleMarkers(lng = ~Longitude, 
                   lat = ~Latitude,
                   popup = ~paste0("<b>", country, "</b><br>", 
                             "Confirmed Cases: <b>", confirmed_readable, "</b><br>", 
                             "Deaths: <b>", deaths_readable, "</b><br>", 
                             "Fatality Ratio: <b>", fatal_readable, "</b><br>"),
                   radius = ~rad,
                   
                   weight = 0.7, # What does this do?
                   stroke =T,  # What does this do?
                   color = "#000000", # What does this do?
                   fillColor = "#525c63", # What does this do?
                   fillOpacity = 0.3) # What does this do?

cases_circles
```

Here you go! You just created an interactive map to visualize COVID data across Europe -- with only a few lines of code.

The great thing about leaflet is that maps are interactive: Try clicking on one of the circle markers. What was the fatality ratio in France in September 2021? Did Denmark or Hungary have more COVID cases in September? Hint for Hungary: Try zooming in. Magic!

# Multiple Layers

If time permits:

Let's say we wanted to know how COVID cases were not only distributed across countries, but also at different points in time. Leaflet has an interesting feature that allows us to add layers to the same map and switch between them using the the `group` argument.

## Confirmed Cases over Time

```{r}
vec <- seq.Date(as.Date('2020-03-01'), to = as.Date('2021-09-01'), by = '1 month')
vec <- as.character(vec)

cases_over_time_layers <- europe %>% 
  group_by(date) %>% 
  filter(mon_yr != '2020-02') %>% 
  mutate(rad = sqrt(confirmed/max(confirmed)) * 60) %>% # Circle radius (arbitrary scaling function for dramatic effect)
  leaflet(options = leafletOptions(minZoom = 3, maxZoom = 6, )) %>% # Leaflet map
  addProviderTiles(providers$CartoDB.Voyager) %>% 
  addCircleMarkers(lng = ~Longitude, 
                   lat = ~Latitude, 
                   radius = ~rad, 
                   popup = ~text,
                   weight = 0.7,
                   stroke = T, 
                   color = '#000000',
                   fillColor = '#525c63', 
                   fillOpacity = 0.5, 
                   group = ~date, 
                   labelOptions = labelOptions(noHide = F)) %>% 
  addLayersControl( # Layer control
    baseGroups = vec, # Using baseGroups adds radio buttons which makes it easier to switch
    options = layersControlOptions(collapsed = FALSE))

cases_over_time_layers
```

Time for analysis: Which countries were most affected by COVID in early 2020? How has it spread across Europe since then?

# Further resources

If we sparked your interest in using Leaflet for R, make sure to check out the following resources:

-   Step-by-step [documentation](http://rstudio.github.io/leaflet/) for Leaflet in R (including code, examples and further links).

-   Leaflet [cheat sheet](https://ugoproto.github.io/ugo_r_doc/pdf/leaflet-cheat-sheet.pdf)

-   Youtube [tutorial](https://www.youtube.com/playlist?list=PLmFi_ou2WwcEyPq7Y9DvzFRLlp9-XvFDb) for basic Leaflet features (e.g., markers, popups, labels and polylines)

-   Collection of free [third-party basemaps](http://leaflet-extras.github.io/leaflet-providers/preview/index.html) (map tiles) for Leaflet

-   Leaflet website for [JavaScript](https://leafletjs.com/) (for those of you interested in the more advanced side of things).

# Sources

This tutorial drew heavily on Riddhiman's article on the [R'tichoke blog](https://rtichoke.netlify.app/post/covid_visualisation_using_leaflet/) (for ideas, code and data) as well as leaflet's [documentation for R](http://rstudio.github.io/leaflet/) (for explanations of leaflet features and code).

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```
